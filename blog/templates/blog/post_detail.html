{% extends 'movies/base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <article class="max-w-3xl mx-auto">
        <!-- Hero Section -->
        <div class="relative mb-8">
            <img src="{{ post.thumbnail }}" 
                 alt="{{ post.title }}" 
                 class="w-full h-[400px] object-cover rounded-xl shadow-lg">
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-6">
                <h1 class="text-4xl font-bold text-white mb-2">{{ post.title }}</h1>
                <div class="flex items-center space-x-4 text-white/80">
                    <span>{{ post.created_at|date:"F d, Y" }}</span>
                    <span>‚Ä¢</span>
                    <span>{{ post.category.name }}</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="prose prose-lg dark:prose-invert max-w-none mb-8">
            {{ post.content|safe }}
        </div>

        <!-- Interaction Buttons -->
        <div class="flex items-center justify-between border-t border-b dark:border-gray-700 py-4 my-8">
            <div class="flex items-center space-x-4">
                {% if user.is_authenticated %}
                    <button onclick="handleVote('like')" 
                            class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800">
                        <span id="likeIcon" class="text-2xl">üëç</span>
                        <span id="likeCount">{{ post.likes }}</span>
                    </button>
                    <button onclick="handleVote('dislike')" 
                            class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800">
                        <span id="dislikeIcon" class="text-2xl">üëé</span>
                        <span id="dislikeCount">{{ post.dislikes }}</span>
                    </button>
                {% else %}
                    <a href="{% url 'login' %}?next={{ request.path }}" 
                       class="text-primary-light dark:text-primary-dark">
                        Login to vote
                    </a>
                {% endif %}
            </div>

            <!-- Share Buttons -->
            <div class="flex items-center space-x-3">
                <button onclick="shareOnSocial('facebook')" 
                        class="p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/>
                    </svg>
                </button>
                <button onclick="shareOnSocial('twitter')" 
                        class="p-2 rounded-full bg-blue-400 text-white hover:bg-blue-500">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5 0-4.55 2.04-4.55 4.54 0 .36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3 0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35 0 12.92-6.92 12.92-12.93 0-.2 0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/>
                    </svg>
                </button>
                <button onclick="copyLink()" 
                        class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Comments Section -->
        <section class="mt-12">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Comments</h2>
            
            <!-- Comment Form -->
            <div class="mt-8">
                {% if user.is_authenticated %}
                    <form id="commentForm" class="mb-8">
                        {% csrf_token %}
                        <textarea id="commentContent" 
                                  class="w-full p-3 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg"
                                  placeholder="Write your comment..."
                                  rows="3"></textarea>
                        <button type="submit" 
                                class="mt-2 px-6 py-2 bg-primary-light dark:bg-primary-dark text-white dark:text-black rounded-lg hover:opacity-90 transition duration-300">
                            Post Comment
                        </button>
                    </form>
                {% else %}
                    <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg text-center">
                        <p class="text-gray-600 dark:text-gray-300">Please 
                            <a href="{% url 'login' %}?next={{ request.path }}" class="text-primary-light dark:text-primary-dark">login</a> 
                            to comment
                        </p>
                    </div>
                {% endif %}
            </div>

            <!-- Comments List -->
            <div id="commentsList" class="space-y-4">
                <!-- Comments will be dynamically inserted here -->
            </div>
        </section>
    </article>
</div>

<script>
    // Voting functionality
function handleVote(action) {
    fetch(`{% url 'blog:handle_vote' post.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => {
        if (response.status === 403) {
            window.location.href = "{% url 'accounts:login' %}?next={{ request.path }}";
            return;
        }
        return response.json();
    })
    .then(data => {
        if (data && data.status === 'success') {
            document.getElementById(`${action}Count`).textContent = data.count;
            const icon = document.getElementById(`${action}Icon`);
            icon.classList.add('scale-125');
            setTimeout(() => icon.classList.remove('scale-125'), 200);
        }
    });
}

// Dynamic Comments
const commentForm = document.getElementById('commentForm');
if (commentForm) {
    commentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            content: document.getElementById('commentContent').value
        };

        fetch(`{% url 'blog:add_comment' post.slug %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (response.status === 403) {
                window.location.href = "{% url 'accounts:login' %}?next={{ request.path }}";
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data && data.status === 'success') {
                loadComments();
                commentForm.reset();
            }
        });
    });
}

function loadComments() {
    fetch(`{% url 'blog:get_comments' post.slug %}`)
        .then(response => response.json())
        .then(data => {
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';
            data.comments.forEach(comment => {
                const commentElement = createCommentElement(comment);
                commentsList.appendChild(commentElement);
            });
        });
}

function createCommentElement(comment) {
    const div = document.createElement('div');
    div.className = 'bg-gray-50 dark:bg-gray-800 p-4 rounded-lg transition-all duration-300 hover:shadow-lg mb-4';
    div.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <div class="font-bold text-gray-800 dark:text-white">${comment.user}</div>
                <div class="text-gray-600 dark:text-gray-400 text-sm">${comment.created_at}</div>
            </div>
            ${comment.can_delete ? `
                <button onclick="deleteComment(${comment.id})" 
                        class="text-red-500 hover:text-red-700 transition-colors duration-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            ` : ''}
        </div>
        <p class="mt-2 text-gray-600 dark:text-gray-300">${comment.content}</p>
    `;
    return div;
}

function deleteComment(commentId) {
    if (confirm('Are you sure you want to delete this comment?')) {
        fetch(`{% url 'blog:delete_comment' comment_id=0 %}`.replace('0', commentId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadComments();
            }
        });
    }
}


// Social sharing functions remain the same
function shareOnSocial(platform) {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ post.title }}');
    
    const urls = {
        facebook: `https://www.facebook.com/sharer/sharer.php?u=${url}`,
        twitter: `https://twitter.com/intent/tweet?url=${url}&text=${title}`
    };
    
    window.open(urls[platform], '_blank', 'width=600,height=400');
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href)
        .then(() => {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
            notification.textContent = 'Link copied to clipboard!';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        });
}

// Initialize comments
loadComments();


</script>
{% endblock %}
